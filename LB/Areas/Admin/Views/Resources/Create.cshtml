@model Resource

@{
    ViewData["Title"] = "Create Resource";
}

<!--Begin Nav-->
<nav class="mb-3">
    <a asp-action="Index" class="btn btn-with-icon btn-indigo">
        <i class="la la-arrow-left"></i>
        Back to List
    </a>
</nav>
<!--End Nav-->

<div id="app" class="card">
    <div class="card-body">
        <form asp-action="Create" method="post" v-on:submit.prevent="SubmitForm" enctype="multipart/form-data">
            <div class="row">
                <div class="col-lg-6">
                    <div class="form-group">
                        <label asp-for="Title"></label>
                        <input asp-for="Title" class="form-control" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="Description"></label>
                        <textarea asp-for="Description" class="form-control editor"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                </div>
				<div class="col-lg-4">
					<div class="form-group">
						<label asp-for="Category"></label>
						<select asp-for="CategoryId" asp-items="@(new SelectList(ViewBag.Categories, "Id", "Name"))" class="form-control select"></select>
					</div>

					<div class="form-group">
						<label asp-for="ResourceAccesses">Resource Access</label>
						<select asp-for="SelectedAccesses" asp-items="@(new SelectList(ViewBag.Accesses, "Id", "Name"))" class="form-control select-multiple"></select>
					</div>

					<div class="form-group">
						<label asp-for="IsLocalResource">Is Local Resource</label>
						<div class="az-toggle">
							<span></span>
							<input type="checkbox" asp-for="IsLocalResource" onchange="app.IsLocalResource = this.checked" hidden />
						</div>
					</div>

					<div class="form-group" v-if="!IsLocalResource">
						<label asp-for="ResourceUrl"></label>
						<input asp-for="ResourceUrl" class="form-control" />
						<span asp-validation-for="ResourceUrl" class="text-danger"></span>
					</div>

					<div class="form-group" v-if="IsLocalResource">
						<label asp-for="LocalFile">Local File</label>
						<input asp-for="LocalFile" class="form-control-file" />
						<span asp-validation-for="LocalFile"></span>
					</div>

					<div class="form-group">
						<label>Featured Image</label>
						<input type="hidden" asp-for="ImageId" />
						<img id="featuredImage" src="" class="img-fluid w-100" alt="" />
						<div class="btn-group w-100">
							<button type="button" class="btn btn-block btn-primary" onclick="GetFeaturedImage()">Choose Image</button>
							<button type="button" class="btn btn-indigo btn-icon" onclick="ResetFeaturedImage()">
								<i class="fa fa-times"></i>
							</button>
						</div>
					</div>

					@*<div class="form-group">
						<label asp-for="IsLocalResource">Requires Login</label>
						<div class="az-toggle">
							<span></span>
							<input type="checkbox" asp-for="RequiresLogin" hidden />
						</div>
					</div>*@

					<button class="btn btn-with-icon btn-primary" v-bind:disabled="isLoading">
						<i class="la la-plus"></i>
						Submit
					</button>
				</div>
            </div>
        </form>
    </div>
    <div class="card-footer">
        @*{{progressValue}}
        <div class="progress">
            <div class="progress-bar" role="progressbar" v-bind:class="progressValue == 100 ? 'bg-success' : 'bg-primary'" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
        </div>*@
        <h4 v-if="isLoading">Uploading...</h4>
        <h4 v-if="isComplete">Finished</h4>
    </div>
</div>


<script>
        console.log($('#IsLocalResource')[0]);
        var app = new Vue({
            el: '#app',
            data: {
                body: '',
                IsLocalResource: false,
                isLoading: false,
                isComplete: false,
                progressValue: 0
            },
            methods: {
                UpdateBody: function () {
                    
                },
                Toggle: function () {
                    alert();
                },
                SubmitForm(e) {
                    var b = $('#editor .ql-editor').html();
                    this.body = b;


                    var formData = new FormData(e.target);

                    $.ajax({
                        @*xhr: () => {
                            this.isLoading = true;

                            var progress = $('.progress');
                            var progressBar = progress.find('.progress-bar');

                            var xhr = new window.XMLHttpRequest();

                            xhr.upload.addEventListener("progress", function (evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = evt.loaded / evt.total;
                                    percentComplete = parseInt(percentComplete * 100);
                                    console.log(percentComplete);

                                    progressBar.css('width', percentComplete + '%');
                                    progressBar.text(percentComplete + '%');
                                }
                            }, false);

                            return xhr;
                        },*@
                        url: '@Url.Action("Create")',
                        method: "POST",
                        contentType: false,
                        processData: false,
                        data: formData,
                        beforeSend: () => {
                            this.isLoading = true;
                            this.progressValue = 0;
                        },
                        uploadProgress: function (event, position, total, percentComplete) {
                            console.log(percentComplete);
                            @*var progress = $('.progress');
                            var progressBar = progress.find('.progress-bar');*@
                        },
                        complete: (xhr) => {
                            this.isLoading = false;
                        },
                        success: () => {
                            this.isLoading = false;
                            this.isComplete = true;
                            window.location.href = '@Url.Action("Index")';
                        }
                    })
                }
            },
            created: function () {
                this.IsLocalResource = $('#IsLocalResource')[0].checked;
            }
        });

        function GetFeaturedImage() {
            $.fancybox.open({
                src: '@Url.Action("ImageGetter", "Gallery")',
                type: 'ajax',
                afterClose: function (instance, current, e) {
                    var button = e ? e.target || e.currentTarget : null;
                    var thumb = button ? $(button).attr('src') : 0;
                    var imageId = button ? $(button).data('id') : 0;

                    $('#featuredImage').attr('src', thumb);
                    $('#ImageId').val(imageId);
                }
            })
        }

        function ResetFeaturedImage() {
            $('#featuredImage').attr('src', '');
            $('#ImageId').val('');
        }
</script>